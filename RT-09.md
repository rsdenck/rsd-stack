# RT-09 — CONTRATO ARQUITETURAL DA RSD-STACK

## 1. Objetivo
Este documento estabelece as regras de ouro para a arquitetura de containers da `rsd-stack`. Qualquer alteração que viole este contrato será considerada uma regressão técnica e deve ser revertida.

## 2. Pilares Obrigatórios

### 2.1 Imagem Base
- **Obrigatório:** Todas as imagens de runtime (ELS, LGS, KBN, WZH, EFW) DEVEM herdar de `rsd/base-runtime:12`.
- **Racional:** Garantir que bibliotecas críticas (`libc`, `libstdc++`) e ferramentas de diagnóstico básico estejam presentes e em versões compatíveis.

### 2.2 Estrutura de Arquivos (Paths Imutáveis)
Todos os serviços devem operar sob o diretório raiz `/opt/rsd/`:
- `/opt/rsd/bin`: Binários e scripts de inicialização.
- `/opt/rsd/config`: Arquivos de configuração (YAML, XML, etc).
- `/opt/rsd/certs`: Certificados e chaves TLS.
- `/opt/rsd/data`: Dados persistentes.
- `/opt/rsd/logs`: Logs de aplicação.
- `/opt/rsd/tmp`: Arquivos temporários.

### 2.3 Gestão de Processos (ENTRYPOINT)
- **Obrigatório:** O uso do `tini` como PID 1 é mandatório: `ENTRYPOINT ["/usr/bin/tini", "--", ...]`.
- **Proibido:** Execução direta de binários via `java -jar` ou `node index.js`. Deve-se utilizar os wrappers oficiais (ex: `/opt/rsd/bin/elasticsearch`) para garantir que sinais do SO sejam respeitados e o tuning de memória seja aplicado.

### 2.4 Identidade e Permissões
- **Usuário:** Todas as aplicações devem rodar com o usuário `rsd` (UID 10001).
- **Escrita:** O usuário `rsd` deve ter permissão de escrita apenas em `data`, `logs` e `tmp`. Os diretórios `bin` e `config` devem ser, idealmente, somente leitura no runtime final.

## 3. O que é PROIBIDO (Nesta Fase)
1.  **Imagens Distroless:** Proibidas até que a estabilidade total da stack seja validada em ambiente de pré-produção.
2.  **Volumes de Configuração em Paths Aleatórios:** Proibido montar arquivos fora de `/opt/rsd/config` ou `/opt/rsd/certs`.
3.  **Execução como Root:** Proibido (exceto no estágio de build das Dockerfiles).
4.  **Acesso à Internet em Runtime:** A stack deve ser capaz de iniciar sem acesso externo (Air-gapped ready).

## 4. Política de Hardening Progressivo
O hardening não deve impedir a funcionalidade. A ordem de prioridade é:
1.  **Funcionalidade:** O serviço sobe e responde ao healthcheck?
2.  **Observabilidade:** Os logs estão sendo gerados em `/opt/rsd/logs`?
3.  **Isolamento:** `cap_drop: ALL` está ativo?
4.  **Imutabilidade:** `read_only: true` está ativo com `tmpfs` nos locais corretos?

## 5. Checklist de Hardening Fase 2 (Futuro)
- [ ] Implementação de `read_only: true` no `docker-compose.yml`.
- [ ] Montagem de `/opt/rsd/tmp` e `/tmp` como `tmpfs`.
- [ ] Criação de perfis `seccomp` customizados para Elasticsearch e Wazuh.
- [ ] Remoção de `curl` e `netcat` da imagem base após estabilização.

---
**Guardião da Arquitetura:** SRE Team / DevOps Architect
**Última Atualização:** 2026-01-15
