name: rsd-stack

services:
  rsd-els:
    image: rsd/els:${RSD_VERSION:-v1.0.0}
    container_name: rsd-els
    user: "10001:10001"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    tmpfs:
      - /tmp:exec,mode=1777
      - /run:exec
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=true
      - xpack.security.http.ssl.key=/opt/rsd/certs/els/els.key
      - xpack.security.http.ssl.certificate=/opt/rsd/certs/els/els.crt
      - xpack.security.http.ssl.certificate_authorities=/opt/rsd/certs/ca/ca.crt
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.key=/opt/rsd/certs/els/els.key
      - xpack.security.transport.ssl.certificate=/opt/rsd/certs/els/els.crt
      - xpack.security.transport.ssl.certificate_authorities=/opt/rsd/certs/ca/ca.crt
    volumes:
      - els_data:/opt/rsd/data
      - els_logs:/opt/rsd/logs
      - ./docker/els/config/elasticsearch.yml:/opt/rsd/config/elasticsearch.yml:ro
      - ./docker/els/config/jvm.options:/opt/rsd/config/jvm.options:ro
      - ./ca:/opt/rsd/certs/ca:ro
      - ./els:/opt/rsd/certs/els:ro
    networks:
      - rsd-net
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -s -k -u elastic:$$ELASTIC_PASSWORD https://localhost:9200/_cluster/health | grep -q '\"status\":\"\\(green\\|yellow\\)\"'"]
      interval: 20s
      timeout: 10s
      retries: 10

  rsd-lgs:
    image: rsd/lgs:${RSD_VERSION:-v1.0.0}
    container_name: rsd-lgs
    user: "10001:10001"
    depends_on:
      rsd-els:
        condition: service_healthy
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
    volumes:
      - lgs_data:/opt/rsd/data
      - lgs_logs:/opt/rsd/logs
      - ./docker/lgs/config/logstash.conf:/opt/rsd/config/logstash.conf:ro
      - ./ca:/opt/rsd/certs/ca:ro
    networks:
      - rsd-net
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9600"]
      interval: 30s
      timeout: 10s
      retries: 5

  rsd-kbn:
    image: rsd/kbn:${RSD_VERSION:-v1.0.0}
    container_name: rsd-kbn
    user: "10001:10001"
    depends_on:
      rsd-els:
        condition: service_healthy
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
    volumes:
      - kbn_data:/opt/rsd/data
      - kbn_logs:/opt/rsd/logs
      - ./docker/kbn/config/kibana.yml:/opt/rsd/config/kibana.yml:ro
      - ./ca:/opt/rsd/certs/ca:ro
      - ./kbn:/opt/rsd/certs/kbn:ro
    networks:
      - rsd-net
    ports:
      - "5601:5601"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-s", "-k", "http://localhost:5601/api/status"]
      interval: 30s
      timeout: 10s
      retries: 5

  rsd-wzh:
    image: rsd/wzh:${RSD_VERSION:-v1.0.0}
    container_name: rsd-wzh
    user: "0:0" # Wazuh ainda requer root para alguns daemons internos
    depends_on:
      rsd-els:
        condition: service_healthy
    ports:
      - "1514:1514/udp"
      - "1515:1515"
      - "55001:55000"
    volumes:
      - wzh_data:/var/ossec/data
      - ./docker/wzh/config/ossec.conf:/var/ossec/etc/ossec.conf:ro
      - ./ca:/opt/rsd/certs/ca:ro
    networks:
      - rsd-net
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/var/ossec/bin/wazuh-control", "status"]
      interval: 30s
      timeout: 10s
      retries: 5

  rsd-efw:
    image: rsd/efw:${RSD_VERSION:-v1.0.0}
    container_name: rsd-efw
    user: "10001:10001"
    depends_on:
      rsd-els:
        condition: service_healthy
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - EF_LICENSE_ACCEPTED=true
    volumes:
      - efw_data:/opt/rsd/data
      - ./docker/efw/config/elastiflow.yml:/opt/rsd/config/elastiflow.yml:ro
      - ./ca:/opt/rsd/certs/ca:ro
    networks:
      - rsd-net
    ports:
      - "2055:2055/udp"
      - "6343:6343/udp"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/opt/rsd/bin/flowcoll", "-v"]
      interval: 30s
      timeout: 10s
      retries: 5

networks:
  rsd-net:
    driver: bridge

volumes:
  els_data:
  els_logs:
  lgs_data:
  lgs_logs:
  kbn_data:
  kbn_logs:
  wzh_data:
  wzh_logs:
  efw_data:
  efw_logs:
